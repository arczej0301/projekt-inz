// hooks/useFinance.js
import { useState, useEffect } from 'react'
import { 
  collection, 
  doc, 
  getDocs, 
  addDoc, 
  updateDoc, 
  deleteDoc, 
  onSnapshot,
  query,
  where,
  orderBy,
  Timestamp
} from 'firebase/firestore'
import { db } from '../config/firebase'

export const useFinance = () => {
  const [transactions, setTransactions] = useState([])
  const [budgets, setBudgets] = useState([])
  const [loading, setLoading] = useState(true)
  const [error, setError] = useState(null)

  // Kategorie transakcji
  const incomeCategories = [
    { id: 'crop_sales', name: 'SprzedaÅ¼ plonÃ³w', icon: 'ðŸŒ¾', color: '#4caf50' },
    { id: 'animal_sales', name: 'SprzedaÅ¼ zwierzÄ…t', icon: 'ðŸ„', color: '#8bc34a' },
    { id: 'animal_products', name: 'Produkty zwierzÄ™ce', icon: 'ðŸ¥›', color: '#2196f3' },
    { id: 'subsidies', name: 'Dotacje', icon: 'ðŸ’°', color: '#ffc107' },
    { id: 'other_income', name: 'Inne przychody', icon: 'ðŸ“ˆ', color: '#9c27b0' }
  ]

  const expenseCategories = [
    { id: 'seeds', name: 'Nasiona', icon: 'ðŸŒ±', color: '#4caf50' },
    { id: 'fertilizers', name: 'Nawozy', icon: 'ðŸ§ª', color: '#ff9800' },
    { id: 'animal_feed', name: 'Pasze', icon: 'ðŸŒ¿', color: '#8bc34a' },
    { id: 'fuel', name: 'Paliwo', icon: 'â›½', color: '#f44336' },
    { id: 'equipment', name: 'SprzÄ™t i czÄ™Å›ci', icon: 'ðŸ› ï¸', color: '#607d8b' },
    { id: 'animals', name: 'Zakup zwierzÄ…t', icon: 'ðŸ„', color: '#795548' },
    { id: 'maintenance', name: 'Naprawy i konserwacja', icon: 'ðŸ”§', color: '#ff5722' },
    { id: 'taxes', name: 'Podatki i opÅ‚aty', icon: 'ðŸ›ï¸', color: '#3f51b5' },
    { id: 'other_expenses', name: 'Inne koszty', icon: 'ðŸ“‰', color: '#e91e63' }
  ]

  // Pobieranie transakcji w czasie rzeczywistym
  useEffect(() => {
    const q = query(
      collection(db, 'finance_transactions'),
      orderBy('date', 'desc')
    )
    
    const unsubscribe = onSnapshot(q, 
      (querySnapshot) => {
        const transactionsData = []
        querySnapshot.forEach((doc) => {
          const data = doc.data()
          transactionsData.push({ 
            id: doc.id, 
            ...data,
            date: data.date?.toDate?.() || data.date
          })
        })
        setTransactions(transactionsData)
        setLoading(false)
      },
      (error) => {
        console.error('BÅ‚Ä…d przy pobieraniu transakcji:', error)
        setError(`BÅ‚Ä…d przy pobieraniu danych: ${error.message}`)
        setLoading(false)
      }
    )

    return () => unsubscribe()
  }, [])

  // Pobieranie budÅ¼etÃ³w
  useEffect(() => {
    const q = query(collection(db, 'finance_budgets'))
    
    const unsubscribe = onSnapshot(q, 
      (querySnapshot) => {
        const budgetsData = []
        querySnapshot.forEach((doc) => {
          budgetsData.push({ id: doc.id, ...doc.data() })
        })
        setBudgets(budgetsData)
      },
      (error) => {
        console.error('BÅ‚Ä…d przy pobieraniu budÅ¼etÃ³w:', error)
      }
    )

    return () => unsubscribe()
  }, [])

  // Dodawanie transakcji
  const addTransaction = async (transactionData) => {
    try {
      const docRef = await addDoc(collection(db, 'finance_transactions'), {
        ...transactionData,
        date: Timestamp.fromDate(new Date(transactionData.date)),
        createdAt: new Date(),
        amount: parseFloat(transactionData.amount)
      })
      return { success: true, id: docRef.id }
    } catch (error) {
      console.error('BÅ‚Ä…d przy dodawaniu transakcji:', error)
      return { success: false, error: error.message }
    }
  }

  // Automatyczne dodawanie transakcji z innych moduÅ‚Ã³w
  const addAutoTransaction = async (type, data) => {
    try {
      const transactionData = {
        type: type, // 'income' lub 'expense'
        category: data.category,
        amount: parseFloat(data.amount),
        description: data.description,
        source: data.source, // 'fields', 'animals', 'warehouse', 'garage'
        sourceId: data.sourceId,
        date: Timestamp.fromDate(new Date()),
        autoGenerated: true,
        createdAt: new Date()
      }

      const docRef = await addDoc(collection(db, 'finance_transactions'), transactionData)
      return { success: true, id: docRef.id }
    } catch (error) {
      console.error('BÅ‚Ä…d przy automatycznym dodawaniu transakcji:', error)
      return { success: false, error: error.message }
    }
  }

  // Aktualizacja transakcji
  const updateTransaction = async (transactionId, updateData) => {
    try {
      const transactionRef = doc(db, 'finance_transactions', transactionId)
      await updateDoc(transactionRef, {
        ...updateData,
        lastUpdate: new Date(),
        amount: parseFloat(updateData.amount)
      })
      return { success: true }
    } catch (error) {
      console.error('BÅ‚Ä…d przy aktualizacji transakcji:', error)
      return { success: false, error: error.message }
    }
  }

  // Usuwanie transakcji
  const deleteTransaction = async (transactionId) => {
    try {
      await deleteDoc(doc(db, 'finance_transactions', transactionId))
      return { success: true }
    } catch (error) {
      console.error('BÅ‚Ä…d przy usuwaniu transakcji:', error)
      return { success: false, error: error.message }
    }
  }

  // ZarzÄ…dzanie budÅ¼etami
  const addBudget = async (budgetData) => {
    try {
      const docRef = await addDoc(collection(db, 'finance_budgets'), {
        ...budgetData,
        createdAt: new Date(),
        amount: parseFloat(budgetData.amount),
        spent: 0
      })
      return { success: true, id: docRef.id }
    } catch (error) {
      console.error('BÅ‚Ä…d przy dodawaniu budÅ¼etu:', error)
      return { success: false, error: error.message }
    }
  }

  const updateBudget = async (budgetId, updateData) => {
    try {
      const budgetRef = doc(db, 'finance_budgets', budgetId)
      await updateDoc(budgetRef, {
        ...updateData,
        lastUpdate: new Date()
      })
      return { success: true }
    } catch (error) {
      console.error('BÅ‚Ä…d przy aktualizacji budÅ¼etu:', error)
      return { success: false, error: error.message }
    }
  }

  // Obliczenia finansowe
  const getFinancialSummary = () => {
    const currentMonth = new Date().getMonth()
    const currentYear = new Date().getFullYear()

    const monthlyIncome = transactions
      .filter(t => t.type === 'income' && 
        t.date?.getMonth?.() === currentMonth && 
        t.date?.getFullYear?.() === currentYear)
      .reduce((sum, t) => sum + (t.amount || 0), 0)

    const monthlyExpenses = transactions
      .filter(t => t.type === 'expense' && 
        t.date?.getMonth?.() === currentMonth && 
        t.date?.getFullYear?.() === currentYear)
      .reduce((sum, t) => sum + (t.amount || 0), 0)

    const totalIncome = transactions
      .filter(t => t.type === 'income')
      .reduce((sum, t) => sum + (t.amount || 0), 0)

    const totalExpenses = transactions
      .filter(t => t.type === 'expense')
      .reduce((sum, t) => sum + (t.amount || 0), 0)

    return {
      monthlyIncome,
      monthlyExpenses,
      monthlyBalance: monthlyIncome - monthlyExpenses,
      totalIncome,
      totalExpenses,
      totalBalance: totalIncome - totalExpenses
    }
  }

  return {
    transactions,
    budgets,
    incomeCategories,
    expenseCategories,
    loading,
    error,
    addTransaction,
    addAutoTransaction,
    updateTransaction,
    deleteTransaction,
    addBudget,
    updateBudget,
    getFinancialSummary
  }
}